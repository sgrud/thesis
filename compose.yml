version: '3'

x-anchor:
  depends: &depends
    condition: service_completed_successfully
  service: &service
    entrypoint: sh -e -c
    network_mode: bridge
    volumes: [.:/mnt/repo]
    working_dir: /mnt/repo

services:
  typedoc:
    <<: *service
    image: node:latest
    command:
      - |
        cd $$(mktemp -d)
        git clone -b "$SGRUD_TAG" "$SGRUD_GIT" .
        npm pack /mnt/repo/res/typedoc-theme
        npm install *.tgz && npm install

        npx typedoc \
          --githubPages false \
          --gitRevision "$SGRUD_TAG" \
          --plugin typedoc-plugin-markdown \
          --plugin typedoc-plugin-mdn-links \
          --plugin @sgrud/typedoc-plugin \
          --plugin @sgrud/typedoc-theme \
          --out /mnt/repo/dist

  pandoc:
    <<: *service
    build: res/pandoc-custom
    depends_on: {typedoc: *depends}
    image: pandoc/custom:latest
    command:
      - |
        FILES=$$(find src -name '*.md' | sort)

        pandoc -d pandoc.typedoc.yml dist/typedoc.md
        pandoc -d pandoc.thesis.yml -o dist/thesis.tex $$FILES
        xelatex -no-pdf -output-directory dist dist/thesis.tex
        makeindex -i -l -r <dist/thesis.idx >>dist/typedoc.tex
        pandoc -d pandoc.thesis.yml -o dist/thesis.pdf $$FILES
